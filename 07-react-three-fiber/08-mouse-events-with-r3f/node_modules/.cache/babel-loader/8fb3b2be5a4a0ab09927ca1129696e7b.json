{"ast":null,"code":"import { Loader, FileLoader, CompressedTexture, UnsignedByteType, LinearFilter, LinearMipmapLinearFilter, sRGBEncoding, LinearEncoding, RGBAFormat, RGBA_ASTC_4x4_Format, RGBA_BPTC_Format, RGBA_ETC2_EAC_Format, RGBA_PVRTC_4BPPV1_Format, RGBA_S3TC_DXT5_Format, RGB_ETC1_Format, RGB_ETC2_Format, RGB_PVRTC_4BPPV1_Format, RGB_S3TC_DXT1_Format, FloatType, HalfFloatType, DataTexture, Data3DTexture, RGFormat, RedFormat } from 'three';\nimport { WorkerPool } from '../utils/WorkerPool.js';\nimport { KHR_DF_TRANSFER_SRGB, KHR_DF_FLAG_ALPHA_PREMULTIPLIED, read, VK_FORMAT_UNDEFINED, KHR_SUPERCOMPRESSION_NONE, KHR_SUPERCOMPRESSION_ZSTD, VK_FORMAT_R32G32B32A32_SFLOAT, VK_FORMAT_R16G16B16A16_SFLOAT, VK_FORMAT_R8G8B8A8_UNORM, VK_FORMAT_R8G8B8A8_SRGB, VK_FORMAT_R32G32_SFLOAT, VK_FORMAT_R16G16_SFLOAT, VK_FORMAT_R8G8_UNORM, VK_FORMAT_R8G8_SRGB, VK_FORMAT_R32_SFLOAT, VK_FORMAT_R16_SFLOAT, VK_FORMAT_R8_SRGB, VK_FORMAT_R8_UNORM } from 'ktx-parse';\nimport { ZSTDDecoder } from 'zstddec';\n/**\n * Loader for KTX 2.0 GPU Texture containers.\n *\n * KTX 2.0 is a container format for various GPU texture formats. The loader\n * supports Basis Universal GPU textures, which can be quickly transcoded to\n * a wide variety of GPU texture compression formats, as well as some\n * uncompressed DataTexture and Data3DTexture formats.\n *\n * References:\n * - KTX: http://github.khronos.org/KTX-Specification/\n * - DFD: https://www.khronos.org/registry/DataFormat/specs/1.3/dataformat.1.3.html#basicdescriptor\n */\n\nconst _taskCache = new WeakMap();\n\nlet _activeLoaders = 0;\n\nlet _zstd;\n\nclass KTX2Loader extends Loader {\n  constructor(manager) {\n    super(manager);\n    this.transcoderPath = '';\n    this.transcoderBinary = null;\n    this.transcoderPending = null;\n    this.workerPool = new WorkerPool();\n    this.workerSourceURL = '';\n    this.workerConfig = null;\n\n    if (typeof MSC_TRANSCODER !== 'undefined') {\n      console.warn('THREE.KTX2Loader: Please update to latest \"basis_transcoder\".' + ' \"msc_basis_transcoder\" is no longer supported in three.js r125+.');\n    }\n  }\n\n  setTranscoderPath(path) {\n    this.transcoderPath = path;\n    return this;\n  }\n\n  setWorkerLimit(num) {\n    this.workerPool.setWorkerLimit(num);\n    return this;\n  }\n\n  detectSupport(renderer) {\n    this.workerConfig = {\n      astcSupported: renderer.extensions.has('WEBGL_compressed_texture_astc'),\n      etc1Supported: renderer.extensions.has('WEBGL_compressed_texture_etc1'),\n      etc2Supported: renderer.extensions.has('WEBGL_compressed_texture_etc'),\n      dxtSupported: renderer.extensions.has('WEBGL_compressed_texture_s3tc'),\n      bptcSupported: renderer.extensions.has('EXT_texture_compression_bptc'),\n      pvrtcSupported: renderer.extensions.has('WEBGL_compressed_texture_pvrtc') || renderer.extensions.has('WEBKIT_WEBGL_compressed_texture_pvrtc')\n    };\n\n    if (renderer.capabilities.isWebGL2) {\n      // https://github.com/mrdoob/three.js/pull/22928\n      this.workerConfig.etc1Supported = false;\n    }\n\n    return this;\n  }\n\n  init() {\n    if (!this.transcoderPending) {\n      // Load transcoder wrapper.\n      const jsLoader = new FileLoader(this.manager);\n      jsLoader.setPath(this.transcoderPath);\n      jsLoader.setWithCredentials(this.withCredentials);\n      const jsContent = jsLoader.loadAsync('basis_transcoder.js'); // Load transcoder WASM binary.\n\n      const binaryLoader = new FileLoader(this.manager);\n      binaryLoader.setPath(this.transcoderPath);\n      binaryLoader.setResponseType('arraybuffer');\n      binaryLoader.setWithCredentials(this.withCredentials);\n      const binaryContent = binaryLoader.loadAsync('basis_transcoder.wasm');\n      this.transcoderPending = Promise.all([jsContent, binaryContent]).then(_ref => {\n        let [jsContent, binaryContent] = _ref;\n        const fn = KTX2Loader.BasisWorker.toString();\n        const body = ['/* constants */', 'let _EngineFormat = ' + JSON.stringify(KTX2Loader.EngineFormat), 'let _TranscoderFormat = ' + JSON.stringify(KTX2Loader.TranscoderFormat), 'let _BasisFormat = ' + JSON.stringify(KTX2Loader.BasisFormat), '/* basis_transcoder.js */', jsContent, '/* worker */', fn.substring(fn.indexOf('{') + 1, fn.lastIndexOf('}'))].join('\\n');\n        this.workerSourceURL = URL.createObjectURL(new Blob([body]));\n        this.transcoderBinary = binaryContent;\n        this.workerPool.setWorkerCreator(() => {\n          const worker = new Worker(this.workerSourceURL);\n          const transcoderBinary = this.transcoderBinary.slice(0);\n          worker.postMessage({\n            type: 'init',\n            config: this.workerConfig,\n            transcoderBinary\n          }, [transcoderBinary]);\n          return worker;\n        });\n      });\n\n      if (_activeLoaders > 0) {\n        // Each instance loads a transcoder and allocates workers, increasing network and memory cost.\n        console.warn('THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues.' + ' Use a single KTX2Loader instance, or call .dispose() on old instances.');\n      }\n\n      _activeLoaders++;\n    }\n\n    return this.transcoderPending;\n  }\n\n  load(url, onLoad, onProgress, onError) {\n    if (this.workerConfig === null) {\n      throw new Error('THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.');\n    }\n\n    const loader = new FileLoader(this.manager);\n    loader.setResponseType('arraybuffer');\n    loader.setWithCredentials(this.withCredentials);\n    loader.load(url, buffer => {\n      // Check for an existing task using this buffer. A transferred buffer cannot be transferred\n      // again from this thread.\n      if (_taskCache.has(buffer)) {\n        const cachedTask = _taskCache.get(buffer);\n\n        return cachedTask.promise.then(onLoad).catch(onError);\n      }\n\n      this._createTexture(buffer).then(texture => onLoad ? onLoad(texture) : null).catch(onError);\n    }, onProgress, onError);\n  }\n\n  _createTextureFrom(transcodeResult) {\n    const {\n      mipmaps,\n      width,\n      height,\n      format,\n      type,\n      error,\n      dfdTransferFn,\n      dfdFlags\n    } = transcodeResult;\n    if (type === 'error') return Promise.reject(error);\n    const texture = new CompressedTexture(mipmaps, width, height, format, UnsignedByteType);\n    texture.minFilter = mipmaps.length === 1 ? LinearFilter : LinearMipmapLinearFilter;\n    texture.magFilter = LinearFilter;\n    texture.generateMipmaps = false;\n    texture.needsUpdate = true;\n    texture.encoding = dfdTransferFn === KHR_DF_TRANSFER_SRGB ? sRGBEncoding : LinearEncoding;\n    texture.premultiplyAlpha = !!(dfdFlags & KHR_DF_FLAG_ALPHA_PREMULTIPLIED);\n    return texture;\n  }\n  /**\n   * @param {ArrayBuffer} buffer\n   * @param {object?} config\n   * @return {Promise<CompressedTexture|DataTexture|Data3DTexture>}\n   */\n\n\n  _createTexture(buffer) {\n    let config = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    const container = read(new Uint8Array(buffer));\n\n    if (container.vkFormat !== VK_FORMAT_UNDEFINED) {\n      return createDataTexture(container);\n    } //\n\n\n    const taskConfig = config;\n    const texturePending = this.init().then(() => {\n      return this.workerPool.postMessage({\n        type: 'transcode',\n        buffer,\n        taskConfig: taskConfig\n      }, [buffer]);\n    }).then(e => this._createTextureFrom(e.data)); // Cache the task result.\n\n    _taskCache.set(buffer, {\n      promise: texturePending\n    });\n\n    return texturePending;\n  }\n\n  dispose() {\n    this.workerPool.dispose();\n    if (this.workerSourceURL) URL.revokeObjectURL(this.workerSourceURL);\n    _activeLoaders--;\n    return this;\n  }\n\n}\n/* CONSTANTS */\n\n\nKTX2Loader.BasisFormat = {\n  ETC1S: 0,\n  UASTC_4x4: 1\n};\nKTX2Loader.TranscoderFormat = {\n  ETC1: 0,\n  ETC2: 1,\n  BC1: 2,\n  BC3: 3,\n  BC4: 4,\n  BC5: 5,\n  BC7_M6_OPAQUE_ONLY: 6,\n  BC7_M5: 7,\n  PVRTC1_4_RGB: 8,\n  PVRTC1_4_RGBA: 9,\n  ASTC_4x4: 10,\n  ATC_RGB: 11,\n  ATC_RGBA_INTERPOLATED_ALPHA: 12,\n  RGBA32: 13,\n  RGB565: 14,\n  BGR565: 15,\n  RGBA4444: 16\n};\nKTX2Loader.EngineFormat = {\n  RGBAFormat: RGBAFormat,\n  RGBA_ASTC_4x4_Format: RGBA_ASTC_4x4_Format,\n  RGBA_BPTC_Format: RGBA_BPTC_Format,\n  RGBA_ETC2_EAC_Format: RGBA_ETC2_EAC_Format,\n  RGBA_PVRTC_4BPPV1_Format: RGBA_PVRTC_4BPPV1_Format,\n  RGBA_S3TC_DXT5_Format: RGBA_S3TC_DXT5_Format,\n  RGB_ETC1_Format: RGB_ETC1_Format,\n  RGB_ETC2_Format: RGB_ETC2_Format,\n  RGB_PVRTC_4BPPV1_Format: RGB_PVRTC_4BPPV1_Format,\n  RGB_S3TC_DXT1_Format: RGB_S3TC_DXT1_Format\n};\n/* WEB WORKER */\n\nKTX2Loader.BasisWorker = function () {\n  let config;\n  let transcoderPending;\n  let BasisModule;\n  const EngineFormat = _EngineFormat; // eslint-disable-line no-undef\n\n  const TranscoderFormat = _TranscoderFormat; // eslint-disable-line no-undef\n\n  const BasisFormat = _BasisFormat; // eslint-disable-line no-undef\n\n  self.addEventListener('message', function (e) {\n    const message = e.data;\n\n    switch (message.type) {\n      case 'init':\n        config = message.config;\n        init(message.transcoderBinary);\n        break;\n\n      case 'transcode':\n        transcoderPending.then(() => {\n          try {\n            const {\n              width,\n              height,\n              hasAlpha,\n              mipmaps,\n              format,\n              dfdTransferFn,\n              dfdFlags\n            } = transcode(message.buffer);\n            const buffers = [];\n\n            for (let i = 0; i < mipmaps.length; ++i) {\n              buffers.push(mipmaps[i].data.buffer);\n            }\n\n            self.postMessage({\n              type: 'transcode',\n              id: message.id,\n              width,\n              height,\n              hasAlpha,\n              mipmaps,\n              format,\n              dfdTransferFn,\n              dfdFlags\n            }, buffers);\n          } catch (error) {\n            console.error(error);\n            self.postMessage({\n              type: 'error',\n              id: message.id,\n              error: error.message\n            });\n          }\n        });\n        break;\n    }\n  });\n\n  function init(wasmBinary) {\n    transcoderPending = new Promise(resolve => {\n      BasisModule = {\n        wasmBinary,\n        onRuntimeInitialized: resolve\n      };\n      BASIS(BasisModule); // eslint-disable-line no-undef\n    }).then(() => {\n      BasisModule.initializeBasis();\n\n      if (BasisModule.KTX2File === undefined) {\n        console.warn('THREE.KTX2Loader: Please update Basis Universal transcoder.');\n      }\n    });\n  }\n\n  function transcode(buffer) {\n    const ktx2File = new BasisModule.KTX2File(new Uint8Array(buffer));\n\n    function cleanup() {\n      ktx2File.close();\n      ktx2File.delete();\n    }\n\n    if (!ktx2File.isValid()) {\n      cleanup();\n      throw new Error('THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file');\n    }\n\n    const basisFormat = ktx2File.isUASTC() ? BasisFormat.UASTC_4x4 : BasisFormat.ETC1S;\n    const width = ktx2File.getWidth();\n    const height = ktx2File.getHeight();\n    const levels = ktx2File.getLevels();\n    const hasAlpha = ktx2File.getHasAlpha();\n    const dfdTransferFn = ktx2File.getDFDTransferFunc();\n    const dfdFlags = ktx2File.getDFDFlags();\n    const {\n      transcoderFormat,\n      engineFormat\n    } = getTranscoderFormat(basisFormat, width, height, hasAlpha);\n\n    if (!width || !height || !levels) {\n      cleanup();\n      throw new Error('THREE.KTX2Loader:\tInvalid texture');\n    }\n\n    if (!ktx2File.startTranscoding()) {\n      cleanup();\n      throw new Error('THREE.KTX2Loader: .startTranscoding failed');\n    }\n\n    const mipmaps = [];\n\n    for (let mip = 0; mip < levels; mip++) {\n      const levelInfo = ktx2File.getImageLevelInfo(mip, 0, 0);\n      const mipWidth = levelInfo.origWidth;\n      const mipHeight = levelInfo.origHeight;\n      const dst = new Uint8Array(ktx2File.getImageTranscodedSizeInBytes(mip, 0, 0, transcoderFormat));\n      const status = ktx2File.transcodeImage(dst, mip, 0, 0, transcoderFormat, 0, -1, -1);\n\n      if (!status) {\n        cleanup();\n        throw new Error('THREE.KTX2Loader: .transcodeImage failed.');\n      }\n\n      mipmaps.push({\n        data: dst,\n        width: mipWidth,\n        height: mipHeight\n      });\n    }\n\n    cleanup();\n    return {\n      width,\n      height,\n      hasAlpha,\n      mipmaps,\n      format: engineFormat,\n      dfdTransferFn,\n      dfdFlags\n    };\n  } //\n  // Optimal choice of a transcoder target format depends on the Basis format (ETC1S or UASTC),\n  // device capabilities, and texture dimensions. The list below ranks the formats separately\n  // for ETC1S and UASTC.\n  //\n  // In some cases, transcoding UASTC to RGBA32 might be preferred for higher quality (at\n  // significant memory cost) compared to ETC1/2, BC1/3, and PVRTC. The transcoder currently\n  // chooses RGBA32 only as a last resort and does not expose that option to the caller.\n\n\n  const FORMAT_OPTIONS = [{\n    if: 'astcSupported',\n    basisFormat: [BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.ASTC_4x4, TranscoderFormat.ASTC_4x4],\n    engineFormat: [EngineFormat.RGBA_ASTC_4x4_Format, EngineFormat.RGBA_ASTC_4x4_Format],\n    priorityETC1S: Infinity,\n    priorityUASTC: 1,\n    needsPowerOfTwo: false\n  }, {\n    if: 'bptcSupported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.BC7_M5, TranscoderFormat.BC7_M5],\n    engineFormat: [EngineFormat.RGBA_BPTC_Format, EngineFormat.RGBA_BPTC_Format],\n    priorityETC1S: 3,\n    priorityUASTC: 2,\n    needsPowerOfTwo: false\n  }, {\n    if: 'dxtSupported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.BC1, TranscoderFormat.BC3],\n    engineFormat: [EngineFormat.RGB_S3TC_DXT1_Format, EngineFormat.RGBA_S3TC_DXT5_Format],\n    priorityETC1S: 4,\n    priorityUASTC: 5,\n    needsPowerOfTwo: false\n  }, {\n    if: 'etc2Supported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.ETC1, TranscoderFormat.ETC2],\n    engineFormat: [EngineFormat.RGB_ETC2_Format, EngineFormat.RGBA_ETC2_EAC_Format],\n    priorityETC1S: 1,\n    priorityUASTC: 3,\n    needsPowerOfTwo: false\n  }, {\n    if: 'etc1Supported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.ETC1],\n    engineFormat: [EngineFormat.RGB_ETC1_Format],\n    priorityETC1S: 2,\n    priorityUASTC: 4,\n    needsPowerOfTwo: false\n  }, {\n    if: 'pvrtcSupported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.PVRTC1_4_RGB, TranscoderFormat.PVRTC1_4_RGBA],\n    engineFormat: [EngineFormat.RGB_PVRTC_4BPPV1_Format, EngineFormat.RGBA_PVRTC_4BPPV1_Format],\n    priorityETC1S: 5,\n    priorityUASTC: 6,\n    needsPowerOfTwo: true\n  }];\n  const ETC1S_OPTIONS = FORMAT_OPTIONS.sort(function (a, b) {\n    return a.priorityETC1S - b.priorityETC1S;\n  });\n  const UASTC_OPTIONS = FORMAT_OPTIONS.sort(function (a, b) {\n    return a.priorityUASTC - b.priorityUASTC;\n  });\n\n  function getTranscoderFormat(basisFormat, width, height, hasAlpha) {\n    let transcoderFormat;\n    let engineFormat;\n    const options = basisFormat === BasisFormat.ETC1S ? ETC1S_OPTIONS : UASTC_OPTIONS;\n\n    for (let i = 0; i < options.length; i++) {\n      const opt = options[i];\n      if (!config[opt.if]) continue;\n      if (!opt.basisFormat.includes(basisFormat)) continue;\n      if (hasAlpha && opt.transcoderFormat.length < 2) continue;\n      if (opt.needsPowerOfTwo && !(isPowerOfTwo(width) && isPowerOfTwo(height))) continue;\n      transcoderFormat = opt.transcoderFormat[hasAlpha ? 1 : 0];\n      engineFormat = opt.engineFormat[hasAlpha ? 1 : 0];\n      return {\n        transcoderFormat,\n        engineFormat\n      };\n    }\n\n    console.warn('THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32.');\n    transcoderFormat = TranscoderFormat.RGBA32;\n    engineFormat = EngineFormat.RGBAFormat;\n    return {\n      transcoderFormat,\n      engineFormat\n    };\n  }\n\n  function isPowerOfTwo(value) {\n    if (value <= 2) return true;\n    return (value & value - 1) === 0 && value !== 0;\n  }\n}; //\n// DataTexture and Data3DTexture parsing.\n\n\nconst FORMAT_MAP = {\n  [VK_FORMAT_R32G32B32A32_SFLOAT]: RGBAFormat,\n  [VK_FORMAT_R16G16B16A16_SFLOAT]: RGBAFormat,\n  [VK_FORMAT_R8G8B8A8_UNORM]: RGBAFormat,\n  [VK_FORMAT_R8G8B8A8_SRGB]: RGBAFormat,\n  [VK_FORMAT_R32G32_SFLOAT]: RGFormat,\n  [VK_FORMAT_R16G16_SFLOAT]: RGFormat,\n  [VK_FORMAT_R8G8_UNORM]: RGFormat,\n  [VK_FORMAT_R8G8_SRGB]: RGFormat,\n  [VK_FORMAT_R32_SFLOAT]: RedFormat,\n  [VK_FORMAT_R16_SFLOAT]: RedFormat,\n  [VK_FORMAT_R8_SRGB]: RedFormat,\n  [VK_FORMAT_R8_UNORM]: RedFormat\n};\nconst TYPE_MAP = {\n  [VK_FORMAT_R32G32B32A32_SFLOAT]: FloatType,\n  [VK_FORMAT_R16G16B16A16_SFLOAT]: HalfFloatType,\n  [VK_FORMAT_R8G8B8A8_UNORM]: UnsignedByteType,\n  [VK_FORMAT_R8G8B8A8_SRGB]: UnsignedByteType,\n  [VK_FORMAT_R32G32_SFLOAT]: FloatType,\n  [VK_FORMAT_R16G16_SFLOAT]: HalfFloatType,\n  [VK_FORMAT_R8G8_UNORM]: UnsignedByteType,\n  [VK_FORMAT_R8G8_SRGB]: UnsignedByteType,\n  [VK_FORMAT_R32_SFLOAT]: FloatType,\n  [VK_FORMAT_R16_SFLOAT]: HalfFloatType,\n  [VK_FORMAT_R8_SRGB]: UnsignedByteType,\n  [VK_FORMAT_R8_UNORM]: UnsignedByteType\n};\nconst ENCODING_MAP = {\n  [VK_FORMAT_R8G8B8A8_SRGB]: sRGBEncoding,\n  [VK_FORMAT_R8G8_SRGB]: sRGBEncoding,\n  [VK_FORMAT_R8_SRGB]: sRGBEncoding\n};\n\nasync function createDataTexture(container) {\n  const {\n    vkFormat,\n    pixelWidth,\n    pixelHeight,\n    pixelDepth\n  } = container;\n\n  if (FORMAT_MAP[vkFormat] === undefined) {\n    throw new Error('THREE.KTX2Loader: Unsupported vkFormat.');\n  } //\n\n\n  const level = container.levels[0];\n  let levelData;\n  let view;\n\n  if (container.supercompressionScheme === KHR_SUPERCOMPRESSION_NONE) {\n    levelData = level.levelData;\n  } else if (container.supercompressionScheme === KHR_SUPERCOMPRESSION_ZSTD) {\n    if (!_zstd) {\n      _zstd = new Promise(async resolve => {\n        const zstd = new ZSTDDecoder();\n        await zstd.init();\n        resolve(zstd);\n      });\n    }\n\n    levelData = (await _zstd).decode(level.levelData, level.uncompressedByteLength);\n  } else {\n    throw new Error('THREE.KTX2Loader: Unsupported supercompressionScheme.');\n  }\n\n  if (TYPE_MAP[vkFormat] === FloatType) {\n    view = new Float32Array(levelData.buffer, levelData.byteOffset, levelData.byteLength / Float32Array.BYTES_PER_ELEMENT);\n  } else if (TYPE_MAP[vkFormat] === HalfFloatType) {\n    view = new Uint16Array(levelData.buffer, levelData.byteOffset, levelData.byteLength / Uint16Array.BYTES_PER_ELEMENT);\n  } else {\n    view = levelData;\n  } //\n\n\n  const texture = pixelDepth === 0 ? new DataTexture(view, pixelWidth, pixelHeight) : new Data3DTexture(view, pixelWidth, pixelHeight, pixelDepth);\n  texture.type = TYPE_MAP[vkFormat];\n  texture.format = FORMAT_MAP[vkFormat];\n  texture.encoding = ENCODING_MAP[vkFormat] || LinearEncoding;\n  texture.needsUpdate = true; //\n\n  return Promise.resolve(texture);\n}\n\nexport { KTX2Loader };","map":{"version":3,"names":["Loader","FileLoader","CompressedTexture","UnsignedByteType","LinearFilter","LinearMipmapLinearFilter","sRGBEncoding","LinearEncoding","RGBAFormat","RGBA_ASTC_4x4_Format","RGBA_BPTC_Format","RGBA_ETC2_EAC_Format","RGBA_PVRTC_4BPPV1_Format","RGBA_S3TC_DXT5_Format","RGB_ETC1_Format","RGB_ETC2_Format","RGB_PVRTC_4BPPV1_Format","RGB_S3TC_DXT1_Format","FloatType","HalfFloatType","DataTexture","Data3DTexture","RGFormat","RedFormat","WorkerPool","KHR_DF_TRANSFER_SRGB","KHR_DF_FLAG_ALPHA_PREMULTIPLIED","read","VK_FORMAT_UNDEFINED","KHR_SUPERCOMPRESSION_NONE","KHR_SUPERCOMPRESSION_ZSTD","VK_FORMAT_R32G32B32A32_SFLOAT","VK_FORMAT_R16G16B16A16_SFLOAT","VK_FORMAT_R8G8B8A8_UNORM","VK_FORMAT_R8G8B8A8_SRGB","VK_FORMAT_R32G32_SFLOAT","VK_FORMAT_R16G16_SFLOAT","VK_FORMAT_R8G8_UNORM","VK_FORMAT_R8G8_SRGB","VK_FORMAT_R32_SFLOAT","VK_FORMAT_R16_SFLOAT","VK_FORMAT_R8_SRGB","VK_FORMAT_R8_UNORM","ZSTDDecoder","_taskCache","WeakMap","_activeLoaders","_zstd","KTX2Loader","constructor","manager","transcoderPath","transcoderBinary","transcoderPending","workerPool","workerSourceURL","workerConfig","MSC_TRANSCODER","console","warn","setTranscoderPath","path","setWorkerLimit","num","detectSupport","renderer","astcSupported","extensions","has","etc1Supported","etc2Supported","dxtSupported","bptcSupported","pvrtcSupported","capabilities","isWebGL2","init","jsLoader","setPath","setWithCredentials","withCredentials","jsContent","loadAsync","binaryLoader","setResponseType","binaryContent","Promise","all","then","fn","BasisWorker","toString","body","JSON","stringify","EngineFormat","TranscoderFormat","BasisFormat","substring","indexOf","lastIndexOf","join","URL","createObjectURL","Blob","setWorkerCreator","worker","Worker","slice","postMessage","type","config","load","url","onLoad","onProgress","onError","Error","loader","buffer","cachedTask","get","promise","catch","_createTexture","texture","_createTextureFrom","transcodeResult","mipmaps","width","height","format","error","dfdTransferFn","dfdFlags","reject","minFilter","length","magFilter","generateMipmaps","needsUpdate","encoding","premultiplyAlpha","container","Uint8Array","vkFormat","createDataTexture","taskConfig","texturePending","e","data","set","dispose","revokeObjectURL","ETC1S","UASTC_4x4","ETC1","ETC2","BC1","BC3","BC4","BC5","BC7_M6_OPAQUE_ONLY","BC7_M5","PVRTC1_4_RGB","PVRTC1_4_RGBA","ASTC_4x4","ATC_RGB","ATC_RGBA_INTERPOLATED_ALPHA","RGBA32","RGB565","BGR565","RGBA4444","BasisModule","_EngineFormat","_TranscoderFormat","_BasisFormat","self","addEventListener","message","hasAlpha","transcode","buffers","i","push","id","wasmBinary","resolve","onRuntimeInitialized","BASIS","initializeBasis","KTX2File","undefined","ktx2File","cleanup","close","delete","isValid","basisFormat","isUASTC","getWidth","getHeight","levels","getLevels","getHasAlpha","getDFDTransferFunc","getDFDFlags","transcoderFormat","engineFormat","getTranscoderFormat","startTranscoding","mip","levelInfo","getImageLevelInfo","mipWidth","origWidth","mipHeight","origHeight","dst","getImageTranscodedSizeInBytes","status","transcodeImage","FORMAT_OPTIONS","if","priorityETC1S","Infinity","priorityUASTC","needsPowerOfTwo","ETC1S_OPTIONS","sort","a","b","UASTC_OPTIONS","options","opt","includes","isPowerOfTwo","value","FORMAT_MAP","TYPE_MAP","ENCODING_MAP","pixelWidth","pixelHeight","pixelDepth","level","levelData","view","supercompressionScheme","zstd","decode","uncompressedByteLength","Float32Array","byteOffset","byteLength","BYTES_PER_ELEMENT","Uint16Array"],"sources":["/home/rodrigorvsn/workspace/study/threejs-journey/07-react-three-fiber/08-mouse-events-with-r3f/node_modules/three-stdlib/loaders/KTX2Loader.js"],"sourcesContent":["import { Loader, FileLoader, CompressedTexture, UnsignedByteType, LinearFilter, LinearMipmapLinearFilter, sRGBEncoding, LinearEncoding, RGBAFormat, RGBA_ASTC_4x4_Format, RGBA_BPTC_Format, RGBA_ETC2_EAC_Format, RGBA_PVRTC_4BPPV1_Format, RGBA_S3TC_DXT5_Format, RGB_ETC1_Format, RGB_ETC2_Format, RGB_PVRTC_4BPPV1_Format, RGB_S3TC_DXT1_Format, FloatType, HalfFloatType, DataTexture, Data3DTexture, RGFormat, RedFormat } from 'three';\nimport { WorkerPool } from '../utils/WorkerPool.js';\nimport { KHR_DF_TRANSFER_SRGB, KHR_DF_FLAG_ALPHA_PREMULTIPLIED, read, VK_FORMAT_UNDEFINED, KHR_SUPERCOMPRESSION_NONE, KHR_SUPERCOMPRESSION_ZSTD, VK_FORMAT_R32G32B32A32_SFLOAT, VK_FORMAT_R16G16B16A16_SFLOAT, VK_FORMAT_R8G8B8A8_UNORM, VK_FORMAT_R8G8B8A8_SRGB, VK_FORMAT_R32G32_SFLOAT, VK_FORMAT_R16G16_SFLOAT, VK_FORMAT_R8G8_UNORM, VK_FORMAT_R8G8_SRGB, VK_FORMAT_R32_SFLOAT, VK_FORMAT_R16_SFLOAT, VK_FORMAT_R8_SRGB, VK_FORMAT_R8_UNORM } from 'ktx-parse';\nimport { ZSTDDecoder } from 'zstddec';\n\n/**\n * Loader for KTX 2.0 GPU Texture containers.\n *\n * KTX 2.0 is a container format for various GPU texture formats. The loader\n * supports Basis Universal GPU textures, which can be quickly transcoded to\n * a wide variety of GPU texture compression formats, as well as some\n * uncompressed DataTexture and Data3DTexture formats.\n *\n * References:\n * - KTX: http://github.khronos.org/KTX-Specification/\n * - DFD: https://www.khronos.org/registry/DataFormat/specs/1.3/dataformat.1.3.html#basicdescriptor\n */\n\nconst _taskCache = new WeakMap();\n\nlet _activeLoaders = 0;\n\nlet _zstd;\n\nclass KTX2Loader extends Loader {\n  constructor(manager) {\n    super(manager);\n    this.transcoderPath = '';\n    this.transcoderBinary = null;\n    this.transcoderPending = null;\n    this.workerPool = new WorkerPool();\n    this.workerSourceURL = '';\n    this.workerConfig = null;\n\n    if (typeof MSC_TRANSCODER !== 'undefined') {\n      console.warn('THREE.KTX2Loader: Please update to latest \"basis_transcoder\".' + ' \"msc_basis_transcoder\" is no longer supported in three.js r125+.');\n    }\n  }\n\n  setTranscoderPath(path) {\n    this.transcoderPath = path;\n    return this;\n  }\n\n  setWorkerLimit(num) {\n    this.workerPool.setWorkerLimit(num);\n    return this;\n  }\n\n  detectSupport(renderer) {\n    this.workerConfig = {\n      astcSupported: renderer.extensions.has('WEBGL_compressed_texture_astc'),\n      etc1Supported: renderer.extensions.has('WEBGL_compressed_texture_etc1'),\n      etc2Supported: renderer.extensions.has('WEBGL_compressed_texture_etc'),\n      dxtSupported: renderer.extensions.has('WEBGL_compressed_texture_s3tc'),\n      bptcSupported: renderer.extensions.has('EXT_texture_compression_bptc'),\n      pvrtcSupported: renderer.extensions.has('WEBGL_compressed_texture_pvrtc') || renderer.extensions.has('WEBKIT_WEBGL_compressed_texture_pvrtc')\n    };\n\n    if (renderer.capabilities.isWebGL2) {\n      // https://github.com/mrdoob/three.js/pull/22928\n      this.workerConfig.etc1Supported = false;\n    }\n\n    return this;\n  }\n\n  init() {\n    if (!this.transcoderPending) {\n      // Load transcoder wrapper.\n      const jsLoader = new FileLoader(this.manager);\n      jsLoader.setPath(this.transcoderPath);\n      jsLoader.setWithCredentials(this.withCredentials);\n      const jsContent = jsLoader.loadAsync('basis_transcoder.js'); // Load transcoder WASM binary.\n\n      const binaryLoader = new FileLoader(this.manager);\n      binaryLoader.setPath(this.transcoderPath);\n      binaryLoader.setResponseType('arraybuffer');\n      binaryLoader.setWithCredentials(this.withCredentials);\n      const binaryContent = binaryLoader.loadAsync('basis_transcoder.wasm');\n      this.transcoderPending = Promise.all([jsContent, binaryContent]).then(([jsContent, binaryContent]) => {\n        const fn = KTX2Loader.BasisWorker.toString();\n        const body = ['/* constants */', 'let _EngineFormat = ' + JSON.stringify(KTX2Loader.EngineFormat), 'let _TranscoderFormat = ' + JSON.stringify(KTX2Loader.TranscoderFormat), 'let _BasisFormat = ' + JSON.stringify(KTX2Loader.BasisFormat), '/* basis_transcoder.js */', jsContent, '/* worker */', fn.substring(fn.indexOf('{') + 1, fn.lastIndexOf('}'))].join('\\n');\n        this.workerSourceURL = URL.createObjectURL(new Blob([body]));\n        this.transcoderBinary = binaryContent;\n        this.workerPool.setWorkerCreator(() => {\n          const worker = new Worker(this.workerSourceURL);\n          const transcoderBinary = this.transcoderBinary.slice(0);\n          worker.postMessage({\n            type: 'init',\n            config: this.workerConfig,\n            transcoderBinary\n          }, [transcoderBinary]);\n          return worker;\n        });\n      });\n\n      if (_activeLoaders > 0) {\n        // Each instance loads a transcoder and allocates workers, increasing network and memory cost.\n        console.warn('THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues.' + ' Use a single KTX2Loader instance, or call .dispose() on old instances.');\n      }\n\n      _activeLoaders++;\n    }\n\n    return this.transcoderPending;\n  }\n\n  load(url, onLoad, onProgress, onError) {\n    if (this.workerConfig === null) {\n      throw new Error('THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.');\n    }\n\n    const loader = new FileLoader(this.manager);\n    loader.setResponseType('arraybuffer');\n    loader.setWithCredentials(this.withCredentials);\n    loader.load(url, buffer => {\n      // Check for an existing task using this buffer. A transferred buffer cannot be transferred\n      // again from this thread.\n      if (_taskCache.has(buffer)) {\n        const cachedTask = _taskCache.get(buffer);\n\n        return cachedTask.promise.then(onLoad).catch(onError);\n      }\n\n      this._createTexture(buffer).then(texture => onLoad ? onLoad(texture) : null).catch(onError);\n    }, onProgress, onError);\n  }\n\n  _createTextureFrom(transcodeResult) {\n    const {\n      mipmaps,\n      width,\n      height,\n      format,\n      type,\n      error,\n      dfdTransferFn,\n      dfdFlags\n    } = transcodeResult;\n    if (type === 'error') return Promise.reject(error);\n    const texture = new CompressedTexture(mipmaps, width, height, format, UnsignedByteType);\n    texture.minFilter = mipmaps.length === 1 ? LinearFilter : LinearMipmapLinearFilter;\n    texture.magFilter = LinearFilter;\n    texture.generateMipmaps = false;\n    texture.needsUpdate = true;\n    texture.encoding = dfdTransferFn === KHR_DF_TRANSFER_SRGB ? sRGBEncoding : LinearEncoding;\n    texture.premultiplyAlpha = !!(dfdFlags & KHR_DF_FLAG_ALPHA_PREMULTIPLIED);\n    return texture;\n  }\n  /**\n   * @param {ArrayBuffer} buffer\n   * @param {object?} config\n   * @return {Promise<CompressedTexture|DataTexture|Data3DTexture>}\n   */\n\n\n  _createTexture(buffer, config = {}) {\n    const container = read(new Uint8Array(buffer));\n\n    if (container.vkFormat !== VK_FORMAT_UNDEFINED) {\n      return createDataTexture(container);\n    } //\n\n\n    const taskConfig = config;\n    const texturePending = this.init().then(() => {\n      return this.workerPool.postMessage({\n        type: 'transcode',\n        buffer,\n        taskConfig: taskConfig\n      }, [buffer]);\n    }).then(e => this._createTextureFrom(e.data)); // Cache the task result.\n\n    _taskCache.set(buffer, {\n      promise: texturePending\n    });\n\n    return texturePending;\n  }\n\n  dispose() {\n    this.workerPool.dispose();\n    if (this.workerSourceURL) URL.revokeObjectURL(this.workerSourceURL);\n    _activeLoaders--;\n    return this;\n  }\n\n}\n/* CONSTANTS */\n\n\nKTX2Loader.BasisFormat = {\n  ETC1S: 0,\n  UASTC_4x4: 1\n};\nKTX2Loader.TranscoderFormat = {\n  ETC1: 0,\n  ETC2: 1,\n  BC1: 2,\n  BC3: 3,\n  BC4: 4,\n  BC5: 5,\n  BC7_M6_OPAQUE_ONLY: 6,\n  BC7_M5: 7,\n  PVRTC1_4_RGB: 8,\n  PVRTC1_4_RGBA: 9,\n  ASTC_4x4: 10,\n  ATC_RGB: 11,\n  ATC_RGBA_INTERPOLATED_ALPHA: 12,\n  RGBA32: 13,\n  RGB565: 14,\n  BGR565: 15,\n  RGBA4444: 16\n};\nKTX2Loader.EngineFormat = {\n  RGBAFormat: RGBAFormat,\n  RGBA_ASTC_4x4_Format: RGBA_ASTC_4x4_Format,\n  RGBA_BPTC_Format: RGBA_BPTC_Format,\n  RGBA_ETC2_EAC_Format: RGBA_ETC2_EAC_Format,\n  RGBA_PVRTC_4BPPV1_Format: RGBA_PVRTC_4BPPV1_Format,\n  RGBA_S3TC_DXT5_Format: RGBA_S3TC_DXT5_Format,\n  RGB_ETC1_Format: RGB_ETC1_Format,\n  RGB_ETC2_Format: RGB_ETC2_Format,\n  RGB_PVRTC_4BPPV1_Format: RGB_PVRTC_4BPPV1_Format,\n  RGB_S3TC_DXT1_Format: RGB_S3TC_DXT1_Format\n};\n/* WEB WORKER */\n\nKTX2Loader.BasisWorker = function () {\n  let config;\n  let transcoderPending;\n  let BasisModule;\n  const EngineFormat = _EngineFormat; // eslint-disable-line no-undef\n\n  const TranscoderFormat = _TranscoderFormat; // eslint-disable-line no-undef\n\n  const BasisFormat = _BasisFormat; // eslint-disable-line no-undef\n\n  self.addEventListener('message', function (e) {\n    const message = e.data;\n\n    switch (message.type) {\n      case 'init':\n        config = message.config;\n        init(message.transcoderBinary);\n        break;\n\n      case 'transcode':\n        transcoderPending.then(() => {\n          try {\n            const {\n              width,\n              height,\n              hasAlpha,\n              mipmaps,\n              format,\n              dfdTransferFn,\n              dfdFlags\n            } = transcode(message.buffer);\n            const buffers = [];\n\n            for (let i = 0; i < mipmaps.length; ++i) {\n              buffers.push(mipmaps[i].data.buffer);\n            }\n\n            self.postMessage({\n              type: 'transcode',\n              id: message.id,\n              width,\n              height,\n              hasAlpha,\n              mipmaps,\n              format,\n              dfdTransferFn,\n              dfdFlags\n            }, buffers);\n          } catch (error) {\n            console.error(error);\n            self.postMessage({\n              type: 'error',\n              id: message.id,\n              error: error.message\n            });\n          }\n        });\n        break;\n    }\n  });\n\n  function init(wasmBinary) {\n    transcoderPending = new Promise(resolve => {\n      BasisModule = {\n        wasmBinary,\n        onRuntimeInitialized: resolve\n      };\n      BASIS(BasisModule); // eslint-disable-line no-undef\n    }).then(() => {\n      BasisModule.initializeBasis();\n\n      if (BasisModule.KTX2File === undefined) {\n        console.warn('THREE.KTX2Loader: Please update Basis Universal transcoder.');\n      }\n    });\n  }\n\n  function transcode(buffer) {\n    const ktx2File = new BasisModule.KTX2File(new Uint8Array(buffer));\n\n    function cleanup() {\n      ktx2File.close();\n      ktx2File.delete();\n    }\n\n    if (!ktx2File.isValid()) {\n      cleanup();\n      throw new Error('THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file');\n    }\n\n    const basisFormat = ktx2File.isUASTC() ? BasisFormat.UASTC_4x4 : BasisFormat.ETC1S;\n    const width = ktx2File.getWidth();\n    const height = ktx2File.getHeight();\n    const levels = ktx2File.getLevels();\n    const hasAlpha = ktx2File.getHasAlpha();\n    const dfdTransferFn = ktx2File.getDFDTransferFunc();\n    const dfdFlags = ktx2File.getDFDFlags();\n    const {\n      transcoderFormat,\n      engineFormat\n    } = getTranscoderFormat(basisFormat, width, height, hasAlpha);\n\n    if (!width || !height || !levels) {\n      cleanup();\n      throw new Error('THREE.KTX2Loader:\tInvalid texture');\n    }\n\n    if (!ktx2File.startTranscoding()) {\n      cleanup();\n      throw new Error('THREE.KTX2Loader: .startTranscoding failed');\n    }\n\n    const mipmaps = [];\n\n    for (let mip = 0; mip < levels; mip++) {\n      const levelInfo = ktx2File.getImageLevelInfo(mip, 0, 0);\n      const mipWidth = levelInfo.origWidth;\n      const mipHeight = levelInfo.origHeight;\n      const dst = new Uint8Array(ktx2File.getImageTranscodedSizeInBytes(mip, 0, 0, transcoderFormat));\n      const status = ktx2File.transcodeImage(dst, mip, 0, 0, transcoderFormat, 0, -1, -1);\n\n      if (!status) {\n        cleanup();\n        throw new Error('THREE.KTX2Loader: .transcodeImage failed.');\n      }\n\n      mipmaps.push({\n        data: dst,\n        width: mipWidth,\n        height: mipHeight\n      });\n    }\n\n    cleanup();\n    return {\n      width,\n      height,\n      hasAlpha,\n      mipmaps,\n      format: engineFormat,\n      dfdTransferFn,\n      dfdFlags\n    };\n  } //\n  // Optimal choice of a transcoder target format depends on the Basis format (ETC1S or UASTC),\n  // device capabilities, and texture dimensions. The list below ranks the formats separately\n  // for ETC1S and UASTC.\n  //\n  // In some cases, transcoding UASTC to RGBA32 might be preferred for higher quality (at\n  // significant memory cost) compared to ETC1/2, BC1/3, and PVRTC. The transcoder currently\n  // chooses RGBA32 only as a last resort and does not expose that option to the caller.\n\n\n  const FORMAT_OPTIONS = [{\n    if: 'astcSupported',\n    basisFormat: [BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.ASTC_4x4, TranscoderFormat.ASTC_4x4],\n    engineFormat: [EngineFormat.RGBA_ASTC_4x4_Format, EngineFormat.RGBA_ASTC_4x4_Format],\n    priorityETC1S: Infinity,\n    priorityUASTC: 1,\n    needsPowerOfTwo: false\n  }, {\n    if: 'bptcSupported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.BC7_M5, TranscoderFormat.BC7_M5],\n    engineFormat: [EngineFormat.RGBA_BPTC_Format, EngineFormat.RGBA_BPTC_Format],\n    priorityETC1S: 3,\n    priorityUASTC: 2,\n    needsPowerOfTwo: false\n  }, {\n    if: 'dxtSupported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.BC1, TranscoderFormat.BC3],\n    engineFormat: [EngineFormat.RGB_S3TC_DXT1_Format, EngineFormat.RGBA_S3TC_DXT5_Format],\n    priorityETC1S: 4,\n    priorityUASTC: 5,\n    needsPowerOfTwo: false\n  }, {\n    if: 'etc2Supported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.ETC1, TranscoderFormat.ETC2],\n    engineFormat: [EngineFormat.RGB_ETC2_Format, EngineFormat.RGBA_ETC2_EAC_Format],\n    priorityETC1S: 1,\n    priorityUASTC: 3,\n    needsPowerOfTwo: false\n  }, {\n    if: 'etc1Supported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.ETC1],\n    engineFormat: [EngineFormat.RGB_ETC1_Format],\n    priorityETC1S: 2,\n    priorityUASTC: 4,\n    needsPowerOfTwo: false\n  }, {\n    if: 'pvrtcSupported',\n    basisFormat: [BasisFormat.ETC1S, BasisFormat.UASTC_4x4],\n    transcoderFormat: [TranscoderFormat.PVRTC1_4_RGB, TranscoderFormat.PVRTC1_4_RGBA],\n    engineFormat: [EngineFormat.RGB_PVRTC_4BPPV1_Format, EngineFormat.RGBA_PVRTC_4BPPV1_Format],\n    priorityETC1S: 5,\n    priorityUASTC: 6,\n    needsPowerOfTwo: true\n  }];\n  const ETC1S_OPTIONS = FORMAT_OPTIONS.sort(function (a, b) {\n    return a.priorityETC1S - b.priorityETC1S;\n  });\n  const UASTC_OPTIONS = FORMAT_OPTIONS.sort(function (a, b) {\n    return a.priorityUASTC - b.priorityUASTC;\n  });\n\n  function getTranscoderFormat(basisFormat, width, height, hasAlpha) {\n    let transcoderFormat;\n    let engineFormat;\n    const options = basisFormat === BasisFormat.ETC1S ? ETC1S_OPTIONS : UASTC_OPTIONS;\n\n    for (let i = 0; i < options.length; i++) {\n      const opt = options[i];\n      if (!config[opt.if]) continue;\n      if (!opt.basisFormat.includes(basisFormat)) continue;\n      if (hasAlpha && opt.transcoderFormat.length < 2) continue;\n      if (opt.needsPowerOfTwo && !(isPowerOfTwo(width) && isPowerOfTwo(height))) continue;\n      transcoderFormat = opt.transcoderFormat[hasAlpha ? 1 : 0];\n      engineFormat = opt.engineFormat[hasAlpha ? 1 : 0];\n      return {\n        transcoderFormat,\n        engineFormat\n      };\n    }\n\n    console.warn('THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32.');\n    transcoderFormat = TranscoderFormat.RGBA32;\n    engineFormat = EngineFormat.RGBAFormat;\n    return {\n      transcoderFormat,\n      engineFormat\n    };\n  }\n\n  function isPowerOfTwo(value) {\n    if (value <= 2) return true;\n    return (value & value - 1) === 0 && value !== 0;\n  }\n}; //\n// DataTexture and Data3DTexture parsing.\n\n\nconst FORMAT_MAP = {\n  [VK_FORMAT_R32G32B32A32_SFLOAT]: RGBAFormat,\n  [VK_FORMAT_R16G16B16A16_SFLOAT]: RGBAFormat,\n  [VK_FORMAT_R8G8B8A8_UNORM]: RGBAFormat,\n  [VK_FORMAT_R8G8B8A8_SRGB]: RGBAFormat,\n  [VK_FORMAT_R32G32_SFLOAT]: RGFormat,\n  [VK_FORMAT_R16G16_SFLOAT]: RGFormat,\n  [VK_FORMAT_R8G8_UNORM]: RGFormat,\n  [VK_FORMAT_R8G8_SRGB]: RGFormat,\n  [VK_FORMAT_R32_SFLOAT]: RedFormat,\n  [VK_FORMAT_R16_SFLOAT]: RedFormat,\n  [VK_FORMAT_R8_SRGB]: RedFormat,\n  [VK_FORMAT_R8_UNORM]: RedFormat\n};\nconst TYPE_MAP = {\n  [VK_FORMAT_R32G32B32A32_SFLOAT]: FloatType,\n  [VK_FORMAT_R16G16B16A16_SFLOAT]: HalfFloatType,\n  [VK_FORMAT_R8G8B8A8_UNORM]: UnsignedByteType,\n  [VK_FORMAT_R8G8B8A8_SRGB]: UnsignedByteType,\n  [VK_FORMAT_R32G32_SFLOAT]: FloatType,\n  [VK_FORMAT_R16G16_SFLOAT]: HalfFloatType,\n  [VK_FORMAT_R8G8_UNORM]: UnsignedByteType,\n  [VK_FORMAT_R8G8_SRGB]: UnsignedByteType,\n  [VK_FORMAT_R32_SFLOAT]: FloatType,\n  [VK_FORMAT_R16_SFLOAT]: HalfFloatType,\n  [VK_FORMAT_R8_SRGB]: UnsignedByteType,\n  [VK_FORMAT_R8_UNORM]: UnsignedByteType\n};\nconst ENCODING_MAP = {\n  [VK_FORMAT_R8G8B8A8_SRGB]: sRGBEncoding,\n  [VK_FORMAT_R8G8_SRGB]: sRGBEncoding,\n  [VK_FORMAT_R8_SRGB]: sRGBEncoding\n};\n\nasync function createDataTexture(container) {\n  const {\n    vkFormat,\n    pixelWidth,\n    pixelHeight,\n    pixelDepth\n  } = container;\n\n  if (FORMAT_MAP[vkFormat] === undefined) {\n    throw new Error('THREE.KTX2Loader: Unsupported vkFormat.');\n  } //\n\n\n  const level = container.levels[0];\n  let levelData;\n  let view;\n\n  if (container.supercompressionScheme === KHR_SUPERCOMPRESSION_NONE) {\n    levelData = level.levelData;\n  } else if (container.supercompressionScheme === KHR_SUPERCOMPRESSION_ZSTD) {\n    if (!_zstd) {\n      _zstd = new Promise(async resolve => {\n        const zstd = new ZSTDDecoder();\n        await zstd.init();\n        resolve(zstd);\n      });\n    }\n\n    levelData = (await _zstd).decode(level.levelData, level.uncompressedByteLength);\n  } else {\n    throw new Error('THREE.KTX2Loader: Unsupported supercompressionScheme.');\n  }\n\n  if (TYPE_MAP[vkFormat] === FloatType) {\n    view = new Float32Array(levelData.buffer, levelData.byteOffset, levelData.byteLength / Float32Array.BYTES_PER_ELEMENT);\n  } else if (TYPE_MAP[vkFormat] === HalfFloatType) {\n    view = new Uint16Array(levelData.buffer, levelData.byteOffset, levelData.byteLength / Uint16Array.BYTES_PER_ELEMENT);\n  } else {\n    view = levelData;\n  } //\n\n\n  const texture = pixelDepth === 0 ? new DataTexture(view, pixelWidth, pixelHeight) : new Data3DTexture(view, pixelWidth, pixelHeight, pixelDepth);\n  texture.type = TYPE_MAP[vkFormat];\n  texture.format = FORMAT_MAP[vkFormat];\n  texture.encoding = ENCODING_MAP[vkFormat] || LinearEncoding;\n  texture.needsUpdate = true; //\n\n  return Promise.resolve(texture);\n}\n\nexport { KTX2Loader };\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}